<!doctype html>
<html lang={language} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Comment the line below to disable View Transitions -->
    <ClientRouter fallback="swap" />

    <!-- AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1193332880003971"
         crossorigin="anonymous"></script>
  </head>
  
  <body class="antialiased text-default bg-page tracking-tight">
    <slot />

    <BasicScripts />
    
    <!-- Updated AdSense View Transition Handler -->
    <script is:inline>
      function initializeAds() {
        if (typeof window !== 'undefined' && window.adsbygoogle) {
          const ads = document.querySelectorAll('.adsbygoogle');
          console.log(`Found ${ads.length} ads to initialize`);
          
          ads.forEach((ad, index) => {
            // Check if ad is already initialized
            if (!ad.hasAttribute('data-adsbygoogle-status')) {
              try {
                window.adsbygoogle.push({});
                console.log(`Ad ${index + 1} initialized`);
              } catch (e) {
                console.log(`AdSense init error for ad ${index + 1}:`, e);
              }
            } else {
              console.log(`Ad ${index + 1} already initialized`);
            }
          });
        }
      }

      // Handle AdSense with view transitions
      document.addEventListener('astro:before-preparation', () => {
        console.log('Clearing ads before navigation');
        // Clear existing ads before navigation
        const ads = document.querySelectorAll('.adsbygoogle');
        ads.forEach((ad, index) => {
          console.log(`Clearing ad ${index + 1}`);
          ad.innerHTML = '';
          ad.removeAttribute('data-adsbygoogle-status');
          ad.removeAttribute('data-ad-status');
        });
      });

      document.addEventListener('astro:after-swap', () => {
        console.log('Reinitializing ads after navigation');
        // Wait a bit longer for DOM to be ready
        setTimeout(() => {
          initializeAds();
        }, 300);
      });

      // Handle initial page load
      document.addEventListener('DOMContentLoaded', () => {
        console.log('Page loaded, initializing ads');
        setTimeout(() => {
          initializeAds();
        }, 100);
      });

      // Fallback initialization
      window.addEventListener('load', () => {
        console.log('Window loaded, checking ads again');
        setTimeout(() => {
          initializeAds();
        }, 500);
      });
    </script>
  </body>
</html>